<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§</title>
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* 1. í™”ë©´ ê°€ë¡œë¹„ ê½‰ ì±„ìš°ê¸° & ë°˜ì‘í˜• */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            margin: 0; padding: 20px; 
            background-color: #f4f6f8; 
            box-sizing: border-box;
        }

        .container {
            width: 100%; 
            max-width: 100%; /* ì œí•œ ì—†ì´ ê½‰ ì±„ì›€ */
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            box-sizing: border-box;
        }

        /* í—¤ë” ì˜ì—­ */
        header {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;
        }
        h2 { margin: 0; color: #333; }
        
        /* ë‚ ì§œ ì…ë ¥ ì¸í’‹ */
        input[type="date"] {
            padding: 8px 12px; font-size: 1rem; border: 1px solid #ddd; border-radius: 5px;
            font-family: inherit; cursor: pointer;
        }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .log-list { list-style: none; padding: 0; margin: 0; }
        .log-item {
            display: flex; flex-wrap: wrap; align-items: center;
            padding: 15px; border-bottom: 1px solid #eee;
            transition: background-color 0.2s; position: relative;
        }
        .log-item:hover { background-color: #f0f7ff; }
        .log-item:last-child { border-bottom: none; }

        /* ë¦¬ìŠ¤íŠ¸ ë‚´ë¶€ ì»¬ëŸ¼ */
        .col-time { width: 150px; color: #666; font-size: 0.9em; }
        .col-name { width: 100px; font-weight: bold; color: #4285F4; }
        .col-address { flex: 1; font-size: 1.05em; color: #333; min-width: 200px; cursor: help; text-decoration: underline dotted #aaa; }
        
        /* ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ */
        .no-data { text-align: center; padding: 40px; color: #999; }

        /* íˆ´íŒ ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map-tooltip {
            display: none; position: fixed; /* í™”ë©´ ê¸°ì¤€ ê³ ì • */
            width: 320px; height: 220px;
            border: 2px solid #4285F4; border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            background: white; z-index: 1000;
            pointer-events: none; /* ì§€ë„ê°€ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ê°€ë¡œì±„ì§€ ì•Šë„ë¡ */
        }
        
        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 600px) {
            .col-time { width: 100%; margin-bottom: 5px; font-size: 0.8em; }
            .col-name { width: 100%; margin-bottom: 5px; }
            .col-address { width: 100%; }
            #map-tooltip { width: 250px; height: 180px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h2>ğŸ“‹ ìœ„ì¹˜ ê¸°ë¡ ëª¨ë‹ˆí„°ë§</h2>
            <div>
                <input type="date" id="datePicker" onchange="loadDataByDate()">
            </div>
        </header>

        <ul id="logList" class="log-list">
            <li class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li>
        </ul>
    </div>

    <div id="map-tooltip">
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
        window.dbRef = ref(db, 'locations');
        window.dbQuery = query;
        window.dbLimit = limitToLast;
        window.dbOnValue = onValue;

        // ì´ˆê¸°í™”: ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¸íŒ…í•˜ê³  ë°ì´í„° ë¡œë“œ
        const today = new Date();
        const year = today.getFullYear();
        const month = ('0' + (today.getMonth() + 1)).slice(-2);
        const day = ('0' + today.getDate()).slice(-2);
        
        document.getElementById('datePicker').value = `${year}-${month}-${day}`;
        
        // ëª¨ë“ˆ ë¡œë“œ í›„ ë°ì´í„° ë¡œë”© ì‹œì‘
        loadDataByDate();
    </script>

    <script>
        let map = null;
        let allData = []; // íŒŒì´ì–´ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ë°ì´í„° ìºì‹œ

        // ë°ì´í„° ë¡œë“œ ë° í•„í„°ë§ í•¨ìˆ˜
        function loadDataByDate() {
            const dateInput = document.getElementById('datePicker').value; // YYYY-MM-DD
            const listContainer = document.getElementById('logList');
            
            listContainer.innerHTML = '<li class="no-data">ë°ì´í„° ì¡°íšŒ ì¤‘...</li>';

            // Firebase ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ì•½ê°„ì˜ ì§€ì—°ì´ ìˆì„ ìˆ˜ ìˆìŒ
            if(!window.dbOnValue) {
                setTimeout(loadDataByDate, 500);
                return;
            }

            // ìµœê·¼ 200ê°œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‚ ì§œë¡œ í•„í„°ë§ (ê°„ë‹¨í•œ êµ¬í˜„ì„ ìœ„í•´)
            const recentPostsQuery = window.dbQuery(window.dbRef, window.dbLimit(200));

            window.dbOnValue(recentPostsQuery, (snapshot) => {
                const data = snapshot.val();
                listContainer.innerHTML = ''; // ì´ˆê¸°í™”

                if (!data) {
                    listContainer.innerHTML = '<li class="no-data">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    return;
                }

                // ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
                let items = Object.values(data);

                // 1. ë‚ ì§œ í•„í„°ë§ (ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì— 'date' í•„ë“œê°€ ìˆë‹¤ê³  ê°€ì •)
                // ì˜ˆì „ ë°ì´í„°ëŠ” date í•„ë“œê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì˜ˆì™¸ì²˜ë¦¬
                let filteredItems = items.filter(item => {
                    if (item.date) {
                        return item.date === dateInput;
                    } else {
                        // date í•„ë“œê°€ ì—†ëŠ” ì˜›ë‚  ë°ì´í„°ëŠ” timestamp ë¬¸ìì—´ë¡œ ëŒ€ì¶© ë¹„êµ (ì„ íƒì‚¬í•­)
                        return false; 
                    }
                });

                // 2. ìµœì‹ ìˆœ ì •ë ¬ (timestamp ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
                filteredItems.sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });

                if (filteredItems.length === 0) {
                    listContainer.innerHTML = '<li class="no-data">ì„ íƒí•œ ë‚ ì§œì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    return;
                }

                // 3. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                filteredItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'log-item';
                    
                    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì—°ê²° (ì£¼ì†Œ ë¶€ë¶„ì— ì˜¬ë ¸ì„ ë•Œ)
                    li.innerHTML = `
                        <div class="col-time">${item.timestamp.split('ì˜¤')[0] || item.timestamp}</div> 
                        <div class="col-name">${item.name || 'ì´ë¦„ì—†ìŒ'}</div>
                        <div class="col-address" 
                             onmouseenter="showMap(event, ${item.latitude}, ${item.longitude})" 
                             onmouseleave="hideMap()">
                            ${item.address}
                        </div>
                    `;
                    listContainer.appendChild(li);
                });
            });
        }

        // ì§€ë„ ë³´ì—¬ì£¼ê¸° (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê·¼ì²˜ì—)
        function showMap(e, lat, lng) {
            const tooltip = document.getElementById('map-tooltip');
            
            // íˆ´íŒ ìœ„ì¹˜ ì„¤ì • (ë§ˆìš°ìŠ¤ ì»¤ì„œ ì˜¤ë¥¸ìª½ ì•„ë˜)
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            
            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²ƒ ë°©ì§€ (ê°„ë‹¨ ë³´ì •)
            tooltip.style.left = Math.min(x, window.innerWidth - 330) + 'px';
            tooltip.style.top = Math.min(y, window.innerHeight - 230) + 'px';
            tooltip.style.display = 'block';

            if (map) {
                map.setView([lat, lng], 16);
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) map.removeLayer(layer);
                });
                L.marker([lat, lng]).addTo(map);
                map.invalidateSize();
            } else {
                map = L.map('map', {
                    center: [lat, lng],
                    zoom: 16,
                    zoomControl: false,
                    attributionControl: false
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([lat, lng]).addTo(map);
            }
        }

        function hideMap() {
            document.getElementById('map-tooltip').style.display = 'none';
        }
    </script>
   <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => console.log('SW Fail'));
    }
  </script>   
</body>
</html>
