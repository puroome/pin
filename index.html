<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        function getTodayDateString() {
            const d = new Date();
            const year = d.getFullYear();
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        // 1. ì¼ë‹¨ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (Keyë¥¼ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •)
        window.saveToFirebase = function(lat, lng, name) {
            const newRef = push(ref(db, 'locations'));
            const data = {
                name: name,
                latitude: lat,
                longitude: lng,
                address: "ğŸ“ ì£¼ì†Œ ë³€í™˜ ì¤‘...", // ì„ì‹œ ë©”ì‹œì§€
                date: getTodayDateString(),
                timestamp: new Date().toLocaleString()
            };
            
            return set(newRef, data)
                .then(() => {
                    return newRef.key; // ì €ì¥ëœ ë°ì´í„°ì˜ ê³ ìœ  ID(Key)ë¥¼ ë°˜í™˜
                });
        };

        // 2. ë‚˜ì¤‘ì— ì£¼ì†Œë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        window.updateFirebaseAddress = function(key, newAddress) {
            const updates = {};
            updates['/locations/' + key + '/address'] = newAddress;
            return update(ref(db), updates);
        };
    </script>

    <script>
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzT2gSUo2rXDvvksuQUfB35NYe-ZTeHvGFJBbv2vOt2wcOimy0VkePTyOsGT4F0FiSo/exec";
        
        function getLocation() {
            const nameInput = document.getElementById('username');
            const name = nameInput.value.trim();

            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                nameInput.focus();
                return;
            }

            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('checkInBtn');

            if (!navigator.geolocation) {
                statusDiv.innerText = "GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
                return;
            }

            statusDiv.innerText = "ğŸ“¡ ìœ„ì¹˜ íŒŒì•… ì¤‘...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    try {
                        // [1ë‹¨ê³„] Firebaseì— ìš°ì„  ì €ì¥ (ì†ë„ í–¥ìƒ!)
                        statusDiv.innerText = "ğŸš€ ë°ì´í„° ì €ì¥ ì¤‘...";
                        
                        // ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ì˜ í•¨ìˆ˜ í˜¸ì¶œ (ë¹„ë™ê¸° ì²˜ë¦¬)
                        const key = await window.saveToFirebase(lat, lng, name);
                        
                        // ì‚¬ìš©ìì—ê²ŒëŠ” ë°”ë¡œ ì„±ê³µ ë©”ì‹œì§€ ë³´ì—¬ì¤Œ
                        statusDiv.innerText = `âœ… ${name}ë‹˜, ì €ì¥ ì™„ë£Œ! (ì£¼ì†Œ ë³€í™˜ ì¤‘...)`;
                        // ë²„íŠ¼ì€ ì•„ì§ ë¹„í™œì„± ìƒíƒœë¡œ ë‘ê±°ë‚˜, ë°”ë¡œ í’€ì–´ì¤˜ë„ ë¨
                        
                        // [2ë‹¨ê³„] ë°±ê·¸ë¼ìš´ë“œì—ì„œ GAS í˜¸ì¶œ (êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ & ì£¼ì†Œ ë³€í™˜)
                        fetch(`${GAS_SCRIPT_URL}?lat=${lat}&lng=${lng}&name=${encodeURIComponent(name)}`)
                        .then(res => res.json())
                        .then(data => {
                            if(data.result === 'success') {
                                // [3ë‹¨ê³„] ë³€í™˜ëœ ì£¼ì†Œë¥¼ Firebaseì— ì—…ë°ì´íŠ¸
                                console.log("ì£¼ì†Œ ë³€í™˜ ì™„ë£Œ:", data.address);
                                if(window.updateFirebaseAddress && key) {
                                    window.updateFirebaseAddress(key, data.address);
                                    statusDiv.innerText = `âœ… ${name}ë‹˜, ì €ì¥ ì™„ë£Œ!`; // ì£¼ì†Œê¹Œì§€ ì™„ë£Œë¨
                                }
                            }
                        })
                        .catch(err => {
                            console.error("GAS ì—ëŸ¬:", err);
                            // GASê°€ ì‹¤íŒ¨í•´ë„ Firebaseì—ëŠ” ì¢Œí‘œê°€ ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì•ˆì‹¬
                        })
                        .finally(() => {
                            btn.disabled = false;
                        });

                    } catch (e) {
                        console.error(e);
                        statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message;
                        btn.disabled = false;
                    }
                },
                (err) => {
                    statusDiv.innerText = "ìœ„ì¹˜ ê¶Œí•œ ì°¨ë‹¨ë¨: " + err.message;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }
    </script>
