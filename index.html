<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œì„ ì²´í¬</title>
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; text-align: center; padding: 20px; color: #333; }
        
        input {
            padding: 12px; font-size: 1.1em; width: 80%; max-width: 300px;
            margin-bottom: 20px; border: 2px solid #ddd; border-radius: 8px; text-align: center;
        }
        input:focus { border-color: #4285F4; outline: none; }

        button {
            padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 8px;
            background-color: #4285F4; color: white; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 80%; max-width: 330px;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #3367D6; }

        #status { margin: 20px 0; color: #666; font-size: 0.9em; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ“ ì¶œì„ ì²´í¬ì¸</h2>
    <p>ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    
    <input type="text" id="username" placeholder="ì´ë¦„ ì…ë ¥" required>
    <br>
    
    <button id="checkInBtn" onclick="getLocation()">ì¶œì„í•˜ê¸°</button>
    <div id="status"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜… Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        function getTodayDateString() {
            const d = new Date();
            const year = d.getFullYear();
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        window.saveToFirebase = function(lat, lng, name) {
            const newRef = push(ref(db, 'locations'));
            const data = {
                name: name,
                latitude: lat,
                longitude: lng,
                address: "í™•ì¸ ì¤‘...", // DB ë‚´ë¶€ ë°ì´í„° (í™”ë©´ ë…¸ì¶œ X)
                date: getTodayDateString(), 
                timestamp: new Date().toLocaleString()
            };
            
            return set(newRef, data).then(() => {
                return newRef.key; 
            });
        };

        window.updateFirebaseAddress = function(key, newAddress) {
            const updates = {};
            updates['/locations/' + key + '/address'] = newAddress;
            return update(ref(db), updates);
        };
    </script>

    <script>
        // â˜… GAS ì›¹ ì•± URL
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzT2gSUo2rXDvvksuQUfB35NYe-ZTeHvGFJBbv2vOt2wcOimy0VkePTyOsGT4F0FiSo/exec";
        
        function getLocation() {
            const nameInput = document.getElementById('username');
            const name = nameInput.value.trim();

            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                nameInput.focus();
                return;
            }

            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('checkInBtn');

            if (!navigator.geolocation) {
                statusDiv.innerText = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¶œì„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            statusDiv.innerText = "ì¶œì„ ì •ë³´ í™•ì¸ ì¤‘...";
            btn.disabled = true; 

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    try {
                        // [1ë‹¨ê³„] Firebase ì €ì¥
                        statusDiv.innerText = "ğŸš€ ë°ì´í„° ì „ì†¡ ì¤‘..."; // 'ì €ì¥' ëŒ€ì‹  'ì „ì†¡'ì´ ë” ì¼ë°˜ì ì„
                        
                        const key = await window.saveToFirebase(lat, lng, name);
                        
                        // [ìˆ˜ì • 3] 'ì£¼ì†Œ í™•ì¸ ì¤‘'ì´ë¼ëŠ” ë§ ì œê±° -> ê´„í˜¸ ë‚´ìš© ì‚­ì œ
                        statusDiv.innerText = `âœ… ${name}ë‹˜, ì¶œì„ ì™„ë£Œ!`;
                        
                        // [2ë‹¨ê³„] ë°±ê·¸ë¼ìš´ë“œ GAS í˜¸ì¶œ
                        fetch(`${GAS_SCRIPT_URL}?lat=${lat}&lng=${lng}&name=${encodeURIComponent(name)}`)
                        .then(res => res.json())
                        .then(data => {
                            if(data.result === 'success') {
                                // ì½˜ì†” ë¡œê·¸ì—ì„œë„ 'ì£¼ì†Œ' ë‹¨ì–´ ì œê±° (í˜¹ì‹œ ê°œë°œì ë„êµ¬ ì¼œë³¼ê¹Œë´)
                                console.log("ë™ê¸°í™” ì™„ë£Œ"); 
                                if(window.updateFirebaseAddress && key) {
                                    window.updateFirebaseAddress(key, data.address);
                                    // ìµœì¢… ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (ì´ë¯¸ ì¶œì„ ì™„ë£Œë¼ê³  ë–´ìœ¼ë‹ˆ ë³€ê²½ ë¶ˆí•„ìš”)
                                }
                            }
                        })
                        .catch(err => {
                            console.error("í†µì‹  ì—ëŸ¬:", err);
                        })
                        .finally(() => {
                            btn.disabled = false;
                        });

                    } catch (e) {
                        console.error(e);
                        statusDiv.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: ì‹œìŠ¤í…œ ì—°ê²° ì‹¤íŒ¨"; // êµ¬ì²´ì  ì—ëŸ¬ ìˆ¨ê¹€
                        btn.disabled = false;
                    }
                },
                (err) => {
                    // [ìˆ˜ì • 4] 'ìœ„ì¹˜ ê¶Œí•œ'ì´ë¼ëŠ” ë§ ëŒ€ì‹  'ì¸ì¦ ê¶Œí•œ'ìœ¼ë¡œ ë‘˜ëŸ¬ëŒ
                    statusDiv.innerText = "ì¶œì„ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œ í—ˆìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.";
                    btn.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }
    </script>
</body>
</html>
