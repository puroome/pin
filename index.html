<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ì¹˜ ì²´í¬ì¸</title>
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; text-align: center; padding: 20px; color: #333; }
        
        input {
            padding: 12px; font-size: 1.1em; width: 80%; max-width: 300px;
            margin-bottom: 20px; border: 2px solid #ddd; border-radius: 8px; text-align: center;
        }
        input:focus { border-color: #4285F4; outline: none; }

        button {
            padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 8px;
            background-color: #4285F4; color: white; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 80%; max-width: 330px;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #3367D6; }

        #status { margin: 20px 0; color: #666; font-size: 0.9em; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ“ ì¶œì„ ì²´í¬ì¸</h2>
    <p>ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    
    <input type="text" id="username" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" required>
    <br>
    
    <button id="checkInBtn" onclick="getLocation()">í˜„ì¬ ìœ„ì¹˜ ì €ì¥í•˜ê¸°</button>
    <div id="status">ëŒ€ê¸° ì¤‘...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜… Firebase ì„¤ì • (ê¸°ì¡´ ì •ë³´ ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD) - ê´€ë¦¬ì í•„í„°ìš©
        function getTodayDateString() {
            const d = new Date();
            const year = d.getFullYear();
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        window.saveToFirebase = function(lat, lng, address, name) {
            const newRef = push(ref(db, 'locations'));
            set(newRef, {
                name: name,                // ì´ë¦„ ì¶”ê°€
                latitude: lat,
                longitude: lng,
                address: address,
                date: getTodayDateString(), // ë‚ ì§œ í•„í„°ìš© (ì˜ˆ: 2023-12-25)
                timestamp: new Date().toLocaleString() // í™”ë©´ í‘œì‹œìš© ì‹œê°„
            }).then(() => {
                document.getElementById('status').innerText = `âœ… ${name}ë‹˜, ì €ì¥ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`;
                document.getElementById('checkInBtn').disabled = false;
            }).catch(e => {
                console.error(e);
                document.getElementById('status').innerText = "âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message;
            });
        };
    </script>

    <script>
        // â˜… GAS ì›¹ ì•± URL (ë°°í¬ í›„ ì£¼ì†Œ í™•ì¸ í•„ìˆ˜)
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzT2gSUo2rXDvvksuQUfB35NYe-ZTeHvGFJBbv2vOt2wcOimy0VkePTyOsGT4F0FiSo/exec";
        
        function getLocation() {
            const nameInput = document.getElementById('username');
            const name = nameInput.value.trim();

            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                nameInput.focus();
                return;
            }

            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('checkInBtn');

            if (!navigator.geolocation) {
                statusDiv.innerText = "GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
                return;
            }

            statusDiv.innerText = "ğŸ“¡ ìœ„ì¹˜ íŒŒì•… ì¤‘...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    statusDiv.innerText = "ğŸ”„ ì£¼ì†Œ ë³€í™˜ ì¤‘...";
                    
                    // GAS í˜¸ì¶œ (ì´ë¦„ë„ ê°™ì´ ì „ì†¡)
                    fetch(`${GAS_SCRIPT_URL}?lat=${lat}&lng=${lng}&name=${encodeURIComponent(name)}`)
                    .then(res => res.json())
                    .then(data => {
                        if(data.result === 'success') {
                            statusDiv.innerText = "ğŸ’¾ DB ì €ì¥ ì¤‘...";
                            if(window.saveToFirebase) {
                                window.saveToFirebase(lat, lng, data.address, name);
                            }
                        } else {
                            statusDiv.innerText = "ì˜¤ë¥˜: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
                            btn.disabled = false;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        statusDiv.innerText = "ì„œë²„ í†µì‹  ì—ëŸ¬";
                        btn.disabled = false;
                    });
                },
                (err) => {
                    statusDiv.innerText = "ìœ„ì¹˜ ê¶Œí•œ ì°¨ë‹¨ë¨: " + err.message;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }
    </script>
</body>
</html>
